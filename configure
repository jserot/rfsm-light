#!/bin/bash

configure_options="$*"
platform=qt6-macm1
qgvlibdir=
#qgvlibdir=../../qgv/dist/macos/lib
appname=rfsm-light
dotprogram='dot'
dotviewer='graphviz'
vcdviewer='gtkwave'
txtviewer='nano'
rfsmc='~/Dev/ml/rfsm/_build/default/src/guests/std/bin/rfsmc.exe'
rfsmlib='~/Dev/ml/rfsm/etc/lib'
doc='yes'
sysc_dir='/usr/local/systemc-2.3.0'
draft=

# Parse command-line arguments

while : ; do
  case "$1" in
    "") break;;
    -platform|--platform)
        platform=$2; shift;;
    -rfsmc|--rfsmc)
        rfsmc=$2; shift;;
    -rfsmlib|--rfsmlib)
        rfsmlib=$2; shift;;
    -no-doc|--no-doc)
        doc='';;
    -dot|--dot)
        dotprogram=$2; shift;;
    -dotviewer|--dotviewer)
        dotviewer=$2; shift;;
    -qgvlibdir|--qgvlibdir)
        qgvlibdir=$2; shift;;
    -vcdviewer|--vcdviewer)
        vcdviewer=$2; shift;;
    -txtviewer|--txtviewer)
        txtviewer=$2; shift;;
    -draft|--draft)
        draft='yes';;
    -help|--help)
        cat <<EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]
  --platform NAME         target platform (qt5-macx86, qt6-ucrt64, qt6-macm1) [default: qt6-macm1]
  --rfsmc PATH            path to the rfsmc compiler [default: $rfsmc]
  --rfsmlib PATH          path to the rfsmc library [default: $rfsmlib]
  --no-doc                do not build the documentation from sources
  --dot NAME              command for runing dot program [default: $dotprogram]
  --dotviewer NAME        command for displaying .dot files [default: $dotviewer]
  --qgvlibdir PATH        path to the directory containing the QGV library name [default: $qgvlibdir]
  --vcdviewer NAME        command for displaying .vcd files [default: $vcdviewer]
  --txtviewer NAME        command for displaying text files [default: $txtviewer]
  --draft                 build for local testing (not for building installers) [default: $draft]
  --help                  print this message
EOF
	exit 0;;
    *) echo "Unknown option \"$1\"." 1>&2; exit 2;;
  esac
  shift
done

rm -f config
touch config
echo "# generated by ./configure $configure_options" >> config
case "$platform" in
  qt6-ucrt64)
      echo "PLATFORM_TYPE=windows" >> config;
      echo "PLATFORM=qt6-ucrt64" >> config;
      echo "QMAKE=/ucrt64/bin/qmake6.exe" >> config;
      echo "QMAKE_SPEC=" >> config;
      echo "WINDEPLOYQT=/ucrt64/bin/windeployqt6.exe" >> config;;
  qt5-macx86)
      echo "PLATFORM_TYPE=macos" >> config;
      echo "PLATFORM=qt5-macx86" >> config;
      echo "QMAKE=/Developer/Qt5.8/5.8/clang_64/bin/qmake" >> config;
      echo "QMAKE_SPEC=-spec macx-clang" >> config;
      echo "WINDEPLOYQT=unused_command" >> config;;
  qt6-macm1)
      echo "PLATFORM_TYPE=macos" >> config;
      echo "PLATFORM=qt6-macm1" >> config;
      echo "QMAKE=~/Qt/6.3.1/macos/bin/qmake" >> config;
      echo "QMAKE_SPEC=-spec macx-clang CONFIG+=arm64" >> config;
      echo "WINDEPLOYQT=unused_command" >> config;;
  *) 
      echo "Unknown platform: $platform";
      rm -f config;
      exit 3;;
esac
echo "QGVLIBDIR=$qgvlibdir" >> config
echo "APPNAME=$appname" >> config
if [ -e VERSION ]; then
    cat VERSION >> config;
fi
echo "RFSMC=$rfsmc" >> config
echo "RFSMLIB=$rfsmlib" >> config
echo "BUILD_DOC=$doc" >> config
if [ -n "$qgvlibdir" ]; then
echo "USE_QGV=yes" >> config
echo "QGVDIR=$qgvlibdir" >> config
else
echo "DOT=dot" >> config
echo "DOTVIEWER=graphviz" >> config
fi
echo "VCDVIEWER=gtkwave" >> config
echo "TXTVIEWER=nano" >> config

echo "** Wrote file ./config"

rm -f ./src/rfsm-light.ini
touch ./src/rfsm-light.ini

case "$platform" in
  qt5-macx86|qt6-macm1)
      if [ -n "$draft" ]; then
          echo "COMPILER=$rfsmc" >> ./src/rfsm-light.ini
      else
          echo "COMPILER=/Applications/RfsmLight.app/Contents/MacOS/rfsmc" >> ./src/rfsm-light.ini
      fi;
    echo "INITDIR=~/Documents" >> ./src/rfsm-light.ini;;
  *) 
      echo "Unknown platform: $platform";
      exit 3;;
esac
echo "DOTPROGRAM=$dotprogram" >> ./src/rfsm-light.ini
echo "DOTVIEWER=$dotviewer" >> ./src/rfsm-light.ini
echo "VCDVIEWER=$vcdviewer" >> ./src/rfsm-light.ini

echo "** Wrote file ./src/rfsm-light.ini"
